<html>
  

  <div id="app">
    <img alt="Vue logo" src="./logo.png" loading="lazy" width="200" height="200">
    <button onclick="refresh()">Click me</button>
    <div id="content">Loading...</div>
  </div>
  

  <style>
  #app {
    font-family: Avenir, Helvetica, Arial, sans-serif;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    text-align: center;
    color: #2c3e50;
    margin-top: 60px;
  }
  h3 {
    margin: 40px 0 0;
  }
  ul {
    list-style-type: none;
    padding: 0;
  }
  li {
    display: inline-block;
    margin: 0 10px;
  }
  a {
    color: #42b983;
  }
  </style>

<script>
  let replace = document.getElementById("content")

  function handleErrors(response) {
    if (!response.ok) {
      console.log("An Error During Check");
      //console.log(response);
      throw new Error(response.status);
    }
    return response;
  }

  let getCache = {}
  let alreadyInProgress = {}
  async function get(file) {
    return new Promise((resolve, reject) => {

      if( file in getCache ) {
        console.log(file+" In Cache")
        resolve(getCache[file])
      } else {
        console.log(file+" Not In Cache")
        getCache[file] = "Loading Please Wait..." // Prevent Doubble downlaods on super slow connections
        fetch(file)
          .then(handleErrors)
          .then((response) => {
            //console.log(response.status)
            //console.log("Unpacking");
            return response.text()
          })
          .then((stringResp) => {
            console.log("Caching And Responding");
            //console.log("String")
            //console.log(stringResp)
            getCache[file] = stringResp
            //console.log("Cache")
            //console.log(getCache[file])
            resolve(stringResp)
          })
          .catch((error) => {
            //console.log("Error Caught in get");
            //console.log(e.status);
            reject(error)
          });
      }

    })
  }

  // Fill cache
  async function prefetch() {
    fetch("/element-count")
      .then(handleErrors)
      .then((response) => {
        return response.text().then((txt) => {
          return parseInt(txt)
        })
      })
      .then((count) => {
        for (i=1; i<=count; i++) {
          get("./pages/"+i.toString()+".html").catch(e => {
            //console.log("Error Caught in general");
            //console.log(e.message);
            if ( parseInt(e.message) === 404){
              console.log("Prefetched Nonexistant File")
              continuePref = false
            } else {
              console.log("Unknown http error: "+e.message+" , Continuing...")
            }
          })
        }
      })
  }

  let c = 1
  function refresh() {
    console.log("MMM Refreshing");
    
    get("./pages/"+c.toString()+".html").then(result => {
      //console.log("Results ")
      //console.log(result)
      replace.innerHTML = result
    })

    if (c === 9){
      c = 1
    } else {
      c++
    }
  }
  refresh()
  prefetch()

</script>

</html>